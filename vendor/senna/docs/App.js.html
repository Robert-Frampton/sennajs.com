<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app/App.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app/App.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>(function(window) {
  <span class="hljs-string">'use strict'</span>;

  <span class="hljs-javadoc">/**
   * App class that handle routes and screens lifecycle.
   * <span class="hljs-javadoctag">@constructor</span>
   * <span class="hljs-javadoctag">@extends</span> {senna.EventEmitter}
   */</span>
  senna.App = function() {
    senna.App.base(<span class="hljs-keyword">this</span>, <span class="hljs-string">'constructor'</span>);

    <span class="hljs-keyword">this</span>.routes = [];
    <span class="hljs-keyword">this</span>.surfaces = {};
    <span class="hljs-keyword">this</span>.screens = {};

    <span class="hljs-keyword">this</span>.docClickEventHandler_ = senna.bind(<span class="hljs-keyword">this</span>.onDocClick_, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.loadEventHandler_ = senna.bind(<span class="hljs-keyword">this</span>.onLoad_, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.popstateEventHandler_ = senna.bind(<span class="hljs-keyword">this</span>.onPopstate_, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.scrollEventHandler_ = senna.debounce(<span class="hljs-keyword">this</span>.onScroll_, <span class="hljs-number">50</span>, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'startNavigate'</span>, <span class="hljs-keyword">this</span>.onStartNavigate_);
    document.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">this</span>.docClickEventHandler_, <span class="hljs-keyword">false</span>);
    window.addEventListener(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">this</span>.loadEventHandler_, <span class="hljs-keyword">false</span>);
    window.addEventListener(<span class="hljs-string">'popstate'</span>, <span class="hljs-keyword">this</span>.popstateEventHandler_, <span class="hljs-keyword">false</span>);
    document.addEventListener(<span class="hljs-string">'scroll'</span>, <span class="hljs-keyword">this</span>.scrollEventHandler_, <span class="hljs-keyword">false</span>);
  };
  senna.inherits(senna.App, senna.EventEmitter);

  <span class="hljs-javadoc">/**
   * Holds the active screen.
   * <span class="hljs-javadoctag">@type</span> {?Screen}
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.activeScreen = <span class="hljs-keyword">null</span>;

  <span class="hljs-javadoc">/**
   * Holds the active path containing the query parameters.
   * <span class="hljs-javadoctag">@type</span> {?String}
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.activePath = <span class="hljs-keyword">null</span>;

  <span class="hljs-javadoc">/**
   * Holds link base path.
   * <span class="hljs-javadoctag">@type</span> {!String}
   * <span class="hljs-javadoctag">@default</span> ''
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.basePath = <span class="hljs-string">''</span>;

  <span class="hljs-javadoc">/**
   * Captures scroll position and saves on history state.
   * <span class="hljs-javadoctag">@type</span> {!Boolean}
   * <span class="hljs-javadoctag">@default</span> true
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.captureHistoryScrollPosition = <span class="hljs-keyword">true</span>;

  <span class="hljs-javadoc">/**
   * Holds the default page title.
   * <span class="hljs-javadoctag">@type</span> {String}
   * <span class="hljs-javadoctag">@default</span> null
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.defaultTitle = <span class="hljs-string">''</span>;

  <span class="hljs-javadoc">/**
   * Holds the link selector to define links that are routed.
   * <span class="hljs-javadoctag">@type</span> {!String}
   * <span class="hljs-javadoctag">@default</span> a:not([data-senna-off])
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.linkSelector = <span class="hljs-string">'a:not([data-senna-off])'</span>;

  <span class="hljs-javadoc">/**
   * Holds the loading css class.
   * <span class="hljs-javadoctag">@type</span> {!String}
   * <span class="hljs-javadoctag">@default</span> senna-loading
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.loadingCssClass = <span class="hljs-string">'senna-loading'</span>;

  <span class="hljs-javadoc">/**
   * Holds the window horizontal scroll position when the navigation using
   * back or forward happens to be restored after the surfaces are updated.
   * <span class="hljs-javadoctag">@type</span> {!Number}
   * <span class="hljs-javadoctag">@default</span> 0
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.syncScrollLeft = <span class="hljs-number">0</span>;

  <span class="hljs-javadoc">/**
   * Holds the window vertical scroll position when the navigation using
   * back or forward happens to be restored after the surfaces are updated.
   * <span class="hljs-javadoctag">@type</span> {!Number}
   * <span class="hljs-javadoctag">@default</span> 0
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.syncScrollTop = <span class="hljs-number">0</span>;

  <span class="hljs-javadoc">/**
   * Holds a deferred withe the current navigation.
   * <span class="hljs-javadoctag">@type</span> {?Promise}
   * <span class="hljs-javadoctag">@default</span> null
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.pendingNavigate = <span class="hljs-keyword">null</span>;

  <span class="hljs-javadoc">/**
     * Updates path before request is made.
     * <span class="hljs-javadoctag">@param</span> {!String} path
     */</span>
  senna.App.prototype.resolvePath = function(path) {
    <span class="hljs-keyword">return</span> path;
  };

  <span class="hljs-javadoc">/**
   * Holds the screen routes configuration.
   * <span class="hljs-javadoctag">@type</span> {?Array}
   * <span class="hljs-javadoctag">@default</span> null
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.routes = <span class="hljs-keyword">null</span>;

  <span class="hljs-javadoc">/**
   * Maps the screen instances by the url containing the parameters.
   * <span class="hljs-javadoctag">@type</span> {?Object}
   * <span class="hljs-javadoctag">@default</span> null
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.screens = <span class="hljs-keyword">null</span>;

  <span class="hljs-javadoc">/**
   * Holds the scroll event handle.
   * <span class="hljs-javadoctag">@type</span> {Object}
   * <span class="hljs-javadoctag">@default</span> null
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.scrollHandle = <span class="hljs-keyword">null</span>;

  <span class="hljs-javadoc">/**
   * When set to true the first erroneous popstate fired on page load will be
   * ignored, only if &lt;code&gt;window.history.state&lt;/code&gt; is also
   * &lt;code&gt;null&lt;/code&gt;.
   * <span class="hljs-javadoctag">@type</span> {Boolean}
   * <span class="hljs-javadoctag">@default</span> false
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.skipLoadPopstate = <span class="hljs-keyword">false</span>;

  <span class="hljs-javadoc">/**
   * Maps that index the surfaces instances by the surface id.
   * <span class="hljs-javadoctag">@type</span> {?Object}
   * <span class="hljs-javadoctag">@default</span> null
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.surfaces = <span class="hljs-keyword">null</span>;

  <span class="hljs-javadoc">/**
   * When set to true, moves the scroll position using the
   * &lt;code&gt;syncScrollLeft&lt;/code&gt; and &lt;code&gt;syncScrollTop&lt;/code&gt; values.
   * <span class="hljs-javadoctag">@type</span> {!Boolean}
   * <span class="hljs-javadoctag">@default</span> true
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.updateScrollPosition = <span class="hljs-keyword">true</span>;

  <span class="hljs-javadoc">/**
   * Adds one or more screens to the application.
   *
   * Example:
   *
   * &lt;code&gt;
   *   app.addRoutes({ path: '/foo', handler: FooScreen });
   *   or
   *   app.addRoutes([{ path: '/foo', handler: function(route) { return new FooScreen(); } }]);
   * &lt;/code&gt;
   *
   * <span class="hljs-javadoctag">@param</span> {Object} or {Array} routes Single object or an array of object.
   *     Each object should contain &lt;code&gt;path&lt;/code&gt; and &lt;code&gt;screen&lt;/code&gt;.
   *     The &lt;code&gt;path&lt;/code&gt; should be a string or a regex that maps the
   *     navigation route to a screen class definition (not an instance), e.g:
   *         &lt;code&gt;{ path: "/home:param1", handler: MyScreen }&lt;/code&gt;
   *         &lt;code&gt;{ path: /foo.+/, handler: MyScreen }&lt;/code&gt;
   * <span class="hljs-javadoctag">@chainable</span>
   */</span>
  senna.App.prototype.addRoutes = function(routes) {
    <span class="hljs-keyword">if</span> (!Array.isArray(routes)) {
      routes = [routes];
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; routes.length; i++) {
      <span class="hljs-keyword">var</span> route = routes[i];
      <span class="hljs-keyword">if</span> (!(route instanceof senna.Route)) {
        route = <span class="hljs-keyword">new</span> senna.Route(route.path, route.handler);
      }
      <span class="hljs-keyword">this</span>.routes.push(route);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };

  <span class="hljs-javadoc">/**
   * Adds one or more surfaces to the application.
   * <span class="hljs-javadoctag">@param</span> {senna.Surface|String|Array.&lt;senna.Surface|senna.String&gt;} surfaces
   *     Surface element id or surface instance. You can also pass an Array
   *     whichcontains surface instances or id. In case of ID, these should be
   *     the id of surface element.
   * <span class="hljs-javadoctag">@chainable</span>
   */</span>
  senna.App.prototype.addSurfaces = function(surfaces) {
    <span class="hljs-keyword">if</span> (!Array.isArray(surfaces)) {
      surfaces = [surfaces];
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; surfaces.length; i++) {
      <span class="hljs-keyword">var</span> surface = surfaces[i];
      <span class="hljs-keyword">if</span> (senna.isString(surface)) {
        surface = <span class="hljs-keyword">new</span> senna.Surface(surface);
      }
      <span class="hljs-keyword">this</span>.surfaces[surface.getId()] = surface;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };

  <span class="hljs-javadoc">/**
   * Retrieves or create a screen instance to a path.
   * <span class="hljs-javadoctag">@param</span> {!String} path Path containing the querystring part.
   * <span class="hljs-javadoctag">@return</span> {senna.Screen}
   */</span>
  senna.App.prototype.createScreenInstance = function(path, route) {
    <span class="hljs-keyword">var</span> cachedScreen;
    <span class="hljs-keyword">if</span> (path === <span class="hljs-keyword">this</span>.activePath) {
      <span class="hljs-comment">// When simulating page refresh the request lifecycle must be respected,</span>
      <span class="hljs-comment">// hence create a new screen instance for the same path.</span>
      console.log(<span class="hljs-string">'Already at destination, refresh navigation'</span>);
      cachedScreen = <span class="hljs-keyword">this</span>.screens[path];
      delete <span class="hljs-keyword">this</span>.screens[path];
    }
    <span class="hljs-comment">/* jshint newcap: false */</span>
    <span class="hljs-keyword">var</span> screen = <span class="hljs-keyword">this</span>.screens[path];
    <span class="hljs-keyword">if</span> (!screen) {
      console.log(<span class="hljs-string">'Create screen for ['</span> + path + <span class="hljs-string">']'</span>);
      <span class="hljs-keyword">var</span> handler = route.getHandler();
      <span class="hljs-keyword">if</span> (handler === senna.Screen || senna.Screen.isImplementedBy(handler.prototype)) {
        screen = <span class="hljs-keyword">new</span> handler();
      } <span class="hljs-keyword">else</span> {
        screen = handler(route) || <span class="hljs-keyword">new</span> senna.Screen();
      }
      <span class="hljs-keyword">if</span> (cachedScreen) {
        screen.addCache(cachedScreen.getCache());
      }
    }
    <span class="hljs-keyword">return</span> screen;
  };

  <span class="hljs-javadoc">/**
   * Destroys app instance and removes all event handlers. All surfaces will
   * be restored to its default content.
   * <span class="hljs-javadoctag">@chainable</span>
   */</span>
  senna.App.prototype.destroy = function() {
    senna.App.base(<span class="hljs-keyword">this</span>, <span class="hljs-string">'destroy'</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> surfaceId in <span class="hljs-keyword">this</span>.surfaces) {
      <span class="hljs-keyword">this</span>.surfaces[surfaceId].remove(<span class="hljs-keyword">this</span>.activeScreen);
      <span class="hljs-keyword">this</span>.surfaces[surfaceId].show();
    }
    window.removeEventListener(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">this</span>.loadEventHandler_, <span class="hljs-keyword">false</span>);
    window.removeEventListener(<span class="hljs-string">'popstate'</span>, <span class="hljs-keyword">this</span>.popstateEventHandler_, <span class="hljs-keyword">false</span>);
    document.removeEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">this</span>.docClickEventHandler_, <span class="hljs-keyword">false</span>);
    document.removeEventListener(<span class="hljs-string">'scroll'</span>, <span class="hljs-keyword">this</span>.scrollEventHandler_, <span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };

  <span class="hljs-javadoc">/**
   * Dispatches to the first route handler that matches the current path, if
   * any.
   * <span class="hljs-javadoctag">@return</span> {Promise} Returns a pending request cancellable promise.
   */</span>
  senna.App.prototype.dispatch = function() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.navigate(window.location.pathname + window.location.search + window.location.hash, <span class="hljs-keyword">true</span>);
  };

  <span class="hljs-javadoc">/**
   * Starts navigation to a path.
   * <span class="hljs-javadoctag">@param</span> {!String} path Path containing the querystring part.
   * <span class="hljs-javadoctag">@param</span> {Boolean=} opt_replaceHistory Replaces browser history.
   * <span class="hljs-javadoctag">@return</span> {Promise} Returns a pending request cancellable promise.
   */</span>
  senna.App.prototype.doNavigate_ = function(path, opt_replaceHistory) {
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">if</span> (self.activeScreen &amp;&amp; self.activeScreen.beforeDeactivate()) {
      <span class="hljs-keyword">this</span>.pendingNavigate = senna.Promise.reject(<span class="hljs-keyword">new</span> senna.Promise.CancellationError(<span class="hljs-string">'Cancelled by active screen'</span>));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pendingNavigate;
    }
    <span class="hljs-keyword">var</span> route = <span class="hljs-keyword">this</span>.findRoute(path);
    <span class="hljs-keyword">if</span> (!route) {
      <span class="hljs-keyword">this</span>.pendingNavigate = senna.Promise.reject(<span class="hljs-keyword">new</span> senna.Promise.CancellationError(<span class="hljs-string">'No route for '</span> + path));
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pendingNavigate;
    }

    <span class="hljs-comment">// When reloading the same path do replaceState instead of pushState to</span>
    <span class="hljs-comment">// avoid polluting history with states with the same path.</span>
    <span class="hljs-keyword">if</span> (path === <span class="hljs-keyword">this</span>.activePath) {
      opt_replaceHistory = <span class="hljs-keyword">true</span>;
    }

    console.log(<span class="hljs-string">'Navigate to ['</span> + path + <span class="hljs-string">']'</span>);

    <span class="hljs-keyword">var</span> nextScreen = <span class="hljs-keyword">this</span>.createScreenInstance(path, route);

    <span class="hljs-keyword">this</span>.pendingNavigate = senna.Promise.resolve()
      .then(function() {
        <span class="hljs-keyword">return</span> nextScreen.load(path);
      })
      .then(function(contents) {
        <span class="hljs-keyword">var</span> screenId = nextScreen.getId();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> surfaceId in self.surfaces) {
          <span class="hljs-keyword">var</span> surface = self.surfaces[surfaceId];
          surface.addContent(screenId, nextScreen.getSurfaceContent(surfaceId, contents));
        }
        <span class="hljs-keyword">if</span> (self.activeScreen) {
          self.activeScreen.deactivate();
        }

        <span class="hljs-keyword">return</span> nextScreen.flip(self.surfaces);
      })
      .then(function() {
        self.finalizeNavigate_(path, nextScreen, opt_replaceHistory);
      })
      .thenCatch(function(reason) {
        self.handleNavigateError_(path, nextScreen, reason);
        <span class="hljs-keyword">throw</span> reason;
      });

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pendingNavigate;
  };

  <span class="hljs-javadoc">/**
   * Finalizes a screen navigation.
   * <span class="hljs-javadoctag">@param</span> {!String} path Path containing the querystring part.
   * <span class="hljs-javadoctag">@param</span> {!Screen} nextScreen
   * <span class="hljs-javadoctag">@param</span> {Boolean=} opt_replaceHistory Replaces browser history.
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.finalizeNavigate_ = function(path, nextScreen, opt_replaceHistory) {
    <span class="hljs-keyword">var</span> activeScreen = <span class="hljs-keyword">this</span>.activeScreen;
    <span class="hljs-keyword">var</span> title = nextScreen.getTitle() || <span class="hljs-keyword">this</span>.getDefaultTitle();

    <span class="hljs-keyword">this</span>.updateHistory_(title, path, opt_replaceHistory);

    <span class="hljs-keyword">this</span>.syncScrollPosition_(opt_replaceHistory);

    document.title = title;

    nextScreen.activate();

    <span class="hljs-keyword">if</span> (activeScreen &amp;&amp; !activeScreen.isCacheable()) {
      <span class="hljs-keyword">this</span>.removeScreen_(<span class="hljs-keyword">this</span>.activePath, activeScreen);
    }

    <span class="hljs-keyword">this</span>.activePath = path;
    <span class="hljs-keyword">this</span>.activeScreen = nextScreen;
    <span class="hljs-keyword">this</span>.screens[path] = nextScreen;
    <span class="hljs-keyword">this</span>.pendingNavigate = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">this</span>.captureHistoryScrollPosition = <span class="hljs-keyword">true</span>;
    console.log(<span class="hljs-string">'Navigation done'</span>);
  };

  <span class="hljs-javadoc">/**
   * Finds a route for the test path. Returns true if matches has a route,
   * otherwise returns null.
   * <span class="hljs-javadoctag">@param</span> {!String} path Path containing the querystring part.
   * <span class="hljs-javadoctag">@return</span> {?Object} Route handler if match any or &lt;code&gt;null&lt;/code&gt; if the
   *     path is the same as the current url and the path contains a fragment.
   */</span>
  senna.App.prototype.findRoute = function(path) {
    <span class="hljs-keyword">var</span> basePath = <span class="hljs-keyword">this</span>.basePath;

    <span class="hljs-comment">// Prevents navigation if it's a hash change on the same url.</span>
    <span class="hljs-keyword">var</span> hashIndex = path.lastIndexOf(<span class="hljs-string">'#'</span>);
    <span class="hljs-keyword">if</span> (hashIndex &gt; -<span class="hljs-number">1</span>) {
      path = path.substr(<span class="hljs-number">0</span>, hashIndex);
      <span class="hljs-keyword">if</span> (path === window.location.pathname + window.location.search) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
      }
    }

    path = path.substr(basePath.length);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.routes.length; i++) {
      <span class="hljs-keyword">var</span> route = <span class="hljs-keyword">this</span>.routes[i];
      <span class="hljs-keyword">if</span> (route.matchesPath(path)) {
        <span class="hljs-keyword">return</span> route;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
  };

  <span class="hljs-javadoc">/**
   * Gets link base path.
   * <span class="hljs-javadoctag">@return</span> {!String}
   */</span>
  senna.App.prototype.getBasePath = function() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.basePath;
  };

  <span class="hljs-javadoc">/**
   * Gets the default page title.
   * <span class="hljs-javadoctag">@return</span> {String} defaultTitle
   */</span>
  senna.App.prototype.getDefaultTitle = function() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.defaultTitle;
  };

  <span class="hljs-javadoc">/**
   * Gets the link selector.
   * <span class="hljs-javadoctag">@return</span> {!String}
   */</span>
  senna.App.prototype.getLinkSelector = function() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.linkSelector;
  };

  <span class="hljs-javadoc">/**
   * Gets the loading css class.
   * <span class="hljs-javadoctag">@return</span> {!String}
   */</span>
  senna.App.prototype.getLoadingCssClass = function() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.loadingCssClass;
  };

  <span class="hljs-javadoc">/**
   * Gets the update scroll position value.
   * <span class="hljs-javadoctag">@return</span> {Boolean}
   */</span>
  senna.App.prototype.getUpdateScrollPosition = function() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateScrollPosition;
  };

  <span class="hljs-javadoc">/**
   * Handle navigation error.
   * <span class="hljs-javadoctag">@param</span> {!String} path Path containing the querystring part.
   * <span class="hljs-javadoctag">@param</span> {!Screen} nextScreen
   * <span class="hljs-javadoctag">@param</span> {!Error} error
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.handleNavigateError_ = function(path, nextScreen, err) {
    console.log(<span class="hljs-string">'Navigation error for ['</span> + nextScreen + <span class="hljs-string">'] ('</span> + err + <span class="hljs-string">')'</span>);
    <span class="hljs-keyword">this</span>.removeScreen_(path, nextScreen);
    <span class="hljs-keyword">this</span>.pendingNavigate = <span class="hljs-keyword">null</span>;
  };

  <span class="hljs-javadoc">/**
   * Tests if hostname is an offsite link.
   * <span class="hljs-javadoctag">@param</span> {!String} hostname Link hostname to compare with
   *     &lt;code&gt;window.location.hostname&lt;/code&gt;.
   * <span class="hljs-javadoctag">@return</span> {Boolean}
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.isLinkSameOrigin_ = function(hostname) {
    <span class="hljs-keyword">return</span> hostname === window.location.hostname;
  };

  <span class="hljs-javadoc">/**
   * Tests if link element has the same app's base path.
   * <span class="hljs-javadoctag">@param</span> {!String} path Link path containing the querystring part.
   * <span class="hljs-javadoctag">@return</span> {Boolean}
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.isSameBasePath_ = function(path) {
    <span class="hljs-keyword">return</span> path.indexOf(<span class="hljs-keyword">this</span>.basePath) === <span class="hljs-number">0</span>;
  };

  <span class="hljs-javadoc">/**
   * Lock the document scroll in order to avoid the browser native back and
   * forward navigation to change the scroll position. Surface app takes care
   * of updating it when surfaces are ready.
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.lockHistoryScrollPosition_ = function() {
    <span class="hljs-keyword">var</span> state = window.history.state;
    <span class="hljs-keyword">if</span> (!state) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// Browsers are inconsistent when re-positioning the scroll history on</span>
    <span class="hljs-comment">// popstate. At some browsers, history scroll happens before popstate, then</span>
    <span class="hljs-comment">// lock the scroll on the last known position as soon as possible after the</span>
    <span class="hljs-comment">// current JS execution context and capture the current value. Some others,</span>
    <span class="hljs-comment">// history scroll happens after popstate, in this case, we bind an once</span>
    <span class="hljs-comment">// scroll event to lock the las known position. Lastly, the previous two</span>
    <span class="hljs-comment">// behaviors can happen even on the same browser, hence the race will decide</span>
    <span class="hljs-comment">// the winner.</span>
    <span class="hljs-keyword">var</span> winner = <span class="hljs-keyword">false</span>;
    <span class="hljs-keyword">var</span> switchScrollPositionRace = function() {
      document.removeEventListener(<span class="hljs-string">'scroll'</span>, switchScrollPositionRace, <span class="hljs-keyword">false</span>);
      <span class="hljs-keyword">if</span> (!winner) {
        window.scrollTo(state.scrollLeft, state.scrollTop);
        winner = <span class="hljs-keyword">true</span>;
      }
    };
    senna.async.nextTick(switchScrollPositionRace);
    document.addEventListener(<span class="hljs-string">'scroll'</span>, switchScrollPositionRace, <span class="hljs-keyword">false</span>);
  };

  <span class="hljs-javadoc">/**
   * Navigates to the specified path if there is a route handler that matches.
   * <span class="hljs-javadoctag">@param</span> {!String} path Path to navigate containing the base path.
   * <span class="hljs-javadoctag">@param</span> {Boolean=} opt_replaceHistory Replaces browser history.
   * <span class="hljs-javadoctag">@return</span> {Promise} Returns a pending request cancellable promise.
   */</span>
  senna.App.prototype.navigate = function(path, opt_replaceHistory) {
    <span class="hljs-keyword">this</span>.stopPending_();

    path = <span class="hljs-keyword">this</span>.resolvePath(path);

    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'startNavigate'</span>, {
      path: path,
      replaceHistory: !!opt_replaceHistory
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pendingNavigate;
  };

  <span class="hljs-javadoc">/**
   * Prefetches the specified path if there is a route handler that matches.
   * <span class="hljs-javadoctag">@param</span> {!String} path Path to navigate containing the base path.
   * <span class="hljs-javadoctag">@return</span> {Promise} Returns a pending request cancellable promise.
   */</span>
  senna.App.prototype.prefetch = function(path) {
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> route = <span class="hljs-keyword">this</span>.findRoute(path);
    <span class="hljs-keyword">if</span> (!route) {
      <span class="hljs-keyword">return</span> senna.Promise.reject(<span class="hljs-keyword">new</span> senna.Promise.CancellationError(<span class="hljs-string">'No route for '</span> + path));
    }

    console.log(<span class="hljs-string">'Prefetching ['</span> + path + <span class="hljs-string">']'</span>);

    <span class="hljs-keyword">var</span> nextScreen = <span class="hljs-keyword">this</span>.createScreenInstance(path, route);
    <span class="hljs-keyword">var</span> pendingPrefetch = senna.Promise.resolve()
      .then(function() {
        <span class="hljs-keyword">return</span> nextScreen.load(path);
      })
      .then(function() {
        self.screens[path] = nextScreen;
      })
      .thenCatch(function(reason) {
        self.removeScreen_(path, nextScreen);
        <span class="hljs-keyword">throw</span> reason;
      });

    <span class="hljs-keyword">return</span> pendingPrefetch;
  };

  <span class="hljs-javadoc">/**
   * Intercepts document clicks and test link elements in order to decide
   * whether Surface app can navigate.
   * <span class="hljs-javadoctag">@param</span> {!Event} event Event facade
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.onDocClick_ = function(event) {
    <span class="hljs-keyword">if</span> (event.altKey || event.ctrlKey || event.metaKey || event.shiftKey || event.button) {
      console.log(<span class="hljs-string">'Navigate aborted, invalid mouse button or modifier key pressed.'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> link = event.target;
    <span class="hljs-keyword">while</span> (link &amp;&amp; link.tagName !== <span class="hljs-string">'A'</span>) {
      link = link.parentNode;
    }
    <span class="hljs-keyword">if</span> (!link) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!senna.<span class="hljs-keyword">match</span>(link, <span class="hljs-keyword">this</span>.linkSelector)) {
      console.log(<span class="hljs-string">'Link not routed.'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> hostname = link.hostname;
    <span class="hljs-keyword">var</span> path = link.pathname + link.search + link.hash;
    <span class="hljs-keyword">var</span> navigateFailed = <span class="hljs-keyword">false</span>;

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isLinkSameOrigin_(hostname)) {
      console.log(<span class="hljs-string">'Offsite link clicked'</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isSameBasePath_(path)) {
      console.log(<span class="hljs-string">'Link clicked outside app\'s base path'</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.findRoute(path)) {
      console.log(<span class="hljs-string">'No route for '</span> + path);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.navigate(path).thenCatch(function() {
      <span class="hljs-comment">// Do not prevent link navigation in case some synchronous error occurs</span>
      navigateFailed = <span class="hljs-keyword">true</span>;
    });

    <span class="hljs-keyword">if</span> (!navigateFailed) {
      event.preventDefault();
    }
  };

  <span class="hljs-javadoc">/**
   * Listens to the window's load event in order to avoid issues with some browsers
   * that trigger popstate calls on the first load. For more information see
   * http://stackoverflow.com/questions/6421769/popstate-on-pages-load-in-chrome.
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.onLoad_ = function() {
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">this</span>.skipLoadPopstate = <span class="hljs-keyword">true</span>;
    setTimeout(function() {
      <span class="hljs-comment">// The timeout ensures that popstate events will be unblocked right</span>
      <span class="hljs-comment">// after the load event occured, but not in the same event-loop cycle.</span>
      self.skipLoadPopstate = <span class="hljs-keyword">false</span>;
    }, <span class="hljs-number">0</span>);
  };

  <span class="hljs-javadoc">/**
   * Handles browser history changes and fires app's navigation if the state
   * belows to us. If we detect a popstate and the state is &lt;code&gt;null&lt;/code&gt;,
   * assume it is navigating to an external page or to a page we don't have
   * route, then &lt;code&gt;window.location.reload()&lt;/code&gt; is invoked in order to
   * reload the content to the current url.
   * <span class="hljs-javadoctag">@param</span> {!Event} event Event facade
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.onPopstate_ = function(event) {
    <span class="hljs-keyword">var</span> state = event.state;

    <span class="hljs-keyword">if</span> (state === <span class="hljs-keyword">null</span> || state.isNullState) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.skipLoadPopstate) {
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">if</span> (!window.location.hash) {
        window.location.reload();
        <span class="hljs-keyword">return</span>;
      }
    }

    <span class="hljs-keyword">if</span> (state &amp;&amp; state.senna) {
      console.log(<span class="hljs-string">'History navigation to ['</span> + state.path + <span class="hljs-string">']'</span>);
      <span class="hljs-keyword">this</span>.syncScrollTop = state.scrollTop;
      <span class="hljs-keyword">this</span>.syncScrollLeft = state.scrollLeft;
      <span class="hljs-keyword">this</span>.lockHistoryScrollPosition_();
      <span class="hljs-keyword">this</span>.navigate(state.path, <span class="hljs-keyword">true</span>);
    }
  };

  <span class="hljs-javadoc">/**
   * Listens document scroll changes in order to capture the possible lock
   * scroll position for history scrolling.
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.onScroll_ = function() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.captureHistoryScrollPosition) {
      <span class="hljs-keyword">this</span>.storeScrollPosition_(window.pageXOffset, window.pageYOffset);
    }
  };

  <span class="hljs-javadoc">/**
   * Starts navigation to a path.
   * <span class="hljs-javadoctag">@param</span> {!Event} event Event facade containing &lt;code&gt;path&lt;/code&gt; and
   *     &lt;code&gt;replaceHistory&lt;/code&gt;.
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.onStartNavigate_ = function(event) {
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> payload = {};

    <span class="hljs-keyword">this</span>.captureHistoryScrollPosition = <span class="hljs-keyword">false</span>;
    <span class="hljs-keyword">this</span>.storeScrollPosition_(window.pageXOffset, window.pageYOffset);

    document.documentElement.classList.add(<span class="hljs-keyword">this</span>.loadingCssClass);

    <span class="hljs-keyword">this</span>.pendingNavigate = <span class="hljs-keyword">this</span>.doNavigate_(event.path, event.replaceHistory)
      .thenCatch(function(err) {
        self.stopPending_();
        payload.error = err;
        <span class="hljs-keyword">throw</span> err;
      })
      .thenAlways(function() {
        payload.path = event.path;
        self.emit(<span class="hljs-string">'endNavigate'</span>, payload);
        document.documentElement.classList.remove(self.loadingCssClass);
      });
  };

  <span class="hljs-javadoc">/**
   * Removes a screen.
   * <span class="hljs-javadoctag">@param</span> {!String} path Path containing the querystring part.
   * <span class="hljs-javadoctag">@param</span> {!Screen} screen
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.removeScreen_ = function(path, screen) {
    <span class="hljs-keyword">var</span> screenId = screen.getId();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i in <span class="hljs-keyword">this</span>.surfaces) {
      <span class="hljs-keyword">this</span>.surfaces[i].remove(screenId);
    }

    screen.destroy();
    delete <span class="hljs-keyword">this</span>.screens[path];
  };

  <span class="hljs-javadoc">/**
   * Sets link base path.
   * <span class="hljs-javadoctag">@param</span> {!String} path
   */</span>
  senna.App.prototype.setBasePath = function(basePath) {
    <span class="hljs-keyword">this</span>.basePath = basePath;
  };

  <span class="hljs-javadoc">/**
   * Sets the default page title.
   * <span class="hljs-javadoctag">@param</span> {String} defaultTitle
   */</span>
  senna.App.prototype.setDefaultTitle = function(defaultTitle) {
    <span class="hljs-keyword">this</span>.defaultTitle = defaultTitle;
  };

  <span class="hljs-javadoc">/**
   * Sets the link selector.
   * <span class="hljs-javadoctag">@param</span> {!String} linkSelector
   */</span>
  senna.App.prototype.setLinkSelector = function(linkSelector) {
    <span class="hljs-keyword">this</span>.linkSelector = linkSelector;
  };

  <span class="hljs-javadoc">/**
   * Sets the loading css class.
   * <span class="hljs-javadoctag">@param</span> {!String} loadingCssClass
   */</span>
  senna.App.prototype.setLoadingCssClass = function(loadingCssClass) {
    <span class="hljs-keyword">this</span>.loadingCssClass = loadingCssClass;
  };

  <span class="hljs-javadoc">/**
   * Sets the update scroll position value.
   * <span class="hljs-javadoctag">@param</span> {Boolean} updateScrollPosition
   */</span>
  senna.App.prototype.setUpdateScrollPosition = function(updateScrollPosition) {
    <span class="hljs-keyword">this</span>.updateScrollPosition = updateScrollPosition;
  };

  <span class="hljs-javadoc">/**
   * Cancels pending navigate with &lt;code&gt;Cancel pending navigation&lt;/code&gt; error.
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.stopPending_ = function() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pendingNavigate) {
      <span class="hljs-keyword">this</span>.pendingNavigate.cancel(<span class="hljs-string">'Cancel pending navigation'</span>);
      <span class="hljs-keyword">this</span>.pendingNavigate = <span class="hljs-keyword">null</span>;
    }
  };

  <span class="hljs-javadoc">/**
   * Updates or replace browser history.
   * <span class="hljs-javadoctag">@param</span> {!String} path Path containing the querystring part.
   * <span class="hljs-javadoctag">@param</span> {?String} title Document title.
   * <span class="hljs-javadoctag">@param</span> {Boolean=} opt_replaceHistory Replaces browser history.
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.updateHistory_ = function(title, path, opt_replaceHistory) {
    <span class="hljs-keyword">var</span> historyParams = {
      path: path,
      senna: <span class="hljs-keyword">true</span>
    };

    <span class="hljs-keyword">if</span> (opt_replaceHistory) {
      window.history.replaceState(historyParams, title, path);
    } <span class="hljs-keyword">else</span> {
      window.history.pushState(historyParams, title, path);
    }
  };

  <span class="hljs-javadoc">/**
   * Stores scroll position and saves on history state.
   * <span class="hljs-javadoctag">@param</span> {!Number} scrollLeft
   * <span class="hljs-javadoctag">@param</span> {!Number} scrollTop
   */</span>
  senna.App.prototype.storeScrollPosition_ = function(scrollLeft, scrollTop) {
    <span class="hljs-keyword">var</span> state = window.history.state || {};
    <span class="hljs-keyword">if</span> (senna.isNull(window.history.state)) {
      state.isNullState = <span class="hljs-keyword">true</span>;
    }
    state.scrollLeft = scrollLeft;
    state.scrollTop = scrollTop;
    window.history.replaceState(state, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);
  };

  <span class="hljs-javadoc">/**
   * Sync document scroll position to the values captured when the default
   * back and forward navigation happened. The scroll position updates after
   * &lt;code&gt;beforeFlip&lt;/code&gt; is called and before the surface transitions.
   * <span class="hljs-javadoctag">@param</span> {Boolean=} opt_replaceHistory Replaces browser history.
   * <span class="hljs-javadoctag">@protected</span>
   */</span>
  senna.App.prototype.syncScrollPosition_ = function(opt_replaceHistory) {
    <span class="hljs-keyword">var</span> scrollLeft = opt_replaceHistory ? <span class="hljs-keyword">this</span>.syncScrollLeft : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> scrollTop = opt_replaceHistory ? <span class="hljs-keyword">this</span>.syncScrollTop : <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.updateScrollPosition) {
      window.scrollTo(scrollLeft, scrollTop);
    }

    <span class="hljs-keyword">this</span>.storeScrollPosition_(scrollLeft, scrollTop);
  };
}(window));
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="senna.App.html">App</a></li><li><a href="senna.Cacheable.html">Cacheable</a></li><li><a href="senna.DataAttributeHandler.html">DataAttributeHandler</a></li><li><a href="senna.EventEmitter.html">EventEmitter</a></li><li><a href="senna.HtmlScreen.html">HtmlScreen</a></li><li><a href="senna.RequestScreen.html">RequestScreen</a></li><li><a href="senna.Route.html">Route</a></li><li><a href="senna.Screen.html">Screen</a></li><li><a href="senna.Surface.html">Surface</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Tue May 05 2015 08:46:22 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
